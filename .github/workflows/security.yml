name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security audit weekly on Monday at 9:00 UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read
  security-events: write

jobs:
  gosec:
    name: Run gosec security scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Download dependencies
        run: go mod download

      - name: Run gosec Security Scanner
        uses: securego/gosec@master
        with:
          # Target specific path patterns
          args: '-exclude-generated -fmt=sarif -out=gosec-results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif
        if: always()

      - name: Run gosec with console output
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -exclude-generated -fmt=text ./...
        if: always()

  security-tests:
    name: Run security tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Download dependencies
        run: go mod download

      - name: Run security tests
        run: go test -v ./tests/security/...

      - name: Run validation tests
        run: go test -v -run "TestValidate|TestSecurity" ./...

  dependency-scan:
    name: Scan dependencies for vulnerabilities
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  credential-scan:
    name: Scan for leaked credentials
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  static-analysis:
    name: Static analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run staticcheck
        uses: dominikh/staticcheck-action@v1.3.0
        with:
          version: "latest"
          install-go: false

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [gosec, security-tests, dependency-scan, credential-scan, static-analysis]
    if: always()
    steps:
      - name: Check status
        run: |
          echo "Security audit completed!"
          echo "gosec: ${{ needs.gosec.result }}"
          echo "security-tests: ${{ needs.security-tests.result }}"
          echo "dependency-scan: ${{ needs.dependency-scan.result }}"
          echo "credential-scan: ${{ needs.credential-scan.result }}"
          echo "static-analysis: ${{ needs.static-analysis.result }}"

      - name: Fail if any critical job failed
        if: |
          needs.gosec.result == 'failure' ||
          needs.security-tests.result == 'failure' ||
          needs.dependency-scan.result == 'failure' ||
          needs.credential-scan.result == 'failure'
        run: exit 1
